# @pexip/media

## 18.3.0

### Minor Changes

- a67b9eb: Introduce `onAudioMuteStateChanged` and `onVideoMuteStateChanged`
  signals

### Patch Changes

- @pexip/media-control@18.3.0
- @pexip/media-processor@18.3.0

## 18.2.0

### Patch Changes

- Updated dependencies [6cb27d9]
  - @pexip/media-control@18.2.0
  - @pexip/utils@16.12.0
  - @pexip/media-processor@18.2.0

## 18.1.0

### Patch Changes

- Updated dependencies [b818713]
  - @pexip/media-processor@18.1.0
  - @pexip/media-control@18.1.0

## 18.0.0

### Major Changes

- bfb8058: Use the lastest version of media-processor

### Minor Changes

- 12fac2c: Fis VideoProcessor Leak

  Closes https://gitlab.com/pexip/zoo/-/issues/4649

### Patch Changes

- d246fbf: ```ts await props.media.release(); cleanUpMainSubscription();

  ```

  are done in the `cleanup` function and removed from `applyChanges` and `revertChanges`. Cleanup is removed from those functions and needs to be called explicitly.
  ```

- Updated dependencies [bfb8058]
- Updated dependencies [79d02d8]
- Updated dependencies [0a5a136]
- Updated dependencies [6b75621]
- Updated dependencies [218a2c0]
- Updated dependencies [bfb8058]
- Updated dependencies [bfb8058]
- Updated dependencies [9bcfc68]
- Updated dependencies [1543a66]
- Updated dependencies [68e8ec1]
  - @pexip/media-processor@18.0.0
  - @pexip/media-control@18.0.0
  - @pexip/utils@16.11.0
  - @pexip/signal@16.7.0

## 17.4.0

### Minor Changes

- 4a1908a: Use tsc to build packages
- fec1c90: Format following Prettier update
- f2a5e0e: Move trackProcessor param to be a functionn

### Patch Changes

- 99e25d2: correct `isInitialPermissionsNotGranted` validator
- Updated dependencies [4a1908a]
- Updated dependencies [fec1c90]
- Updated dependencies [ec134d1]
- Updated dependencies [24fe7e1]
  - @pexip/signal@16.7.0
  - @pexip/utils@16.10.0
  - @pexip/media-control@17.4.0
  - @pexip/media-processor@17.4.0

## 17.3.0

### Minor Changes

- 7abdb2332a: Allow force to applyChanges for preview controller
- 7b29d953: Update babel/traverse related deps
- acb51c1ee1: Resolution from the preview should not affect the main

### Patch Changes

- Updated dependencies [68c3ba1bb8]
- Updated dependencies [7b29d953]
- Updated dependencies [821d9a1ef8]
- Updated dependencies [96f3ce8802]
  - @pexip/media-processor@17.3.0
  - @pexip/media-control@17.3.0
  - @pexip/utils@16.9.0
  - @pexip/signal@16.6.0

## 17.2.0

### Minor Changes

- 0a58ae61: Stablize constraints after release
- 26878b60: Add `contentHint` to constraints

  - Add a new constraint: `contentHint`

- 7e02391e9c: Changest to support FECC and PTZ capabilities
- 244cb04c: Add `createGetDisplayMedia`

### Patch Changes

- 4ea55a5205: Prettier and linting for new prettier version.
- Updated dependencies [244cb04c]
- Updated dependencies [26878b60]
- Updated dependencies [c418c778]
- Updated dependencies [244cb04c]
- Updated dependencies [7e02391e9c]
- Updated dependencies [4ea55a5205]
  - @pexip/media-control@17.2.0
  - @pexip/media-processor@17.2.0
  - @pexip/utils@16.8.0
  - @pexip/signal@16.6.0

## 17.1.2

### Patch Changes

- Updated dependencies [bcfa59f]
  - @pexip/signal@16.6.0
  - @pexip/media-control@17.1.2
  - @pexip/media-processor@17.1.2

## 17.1.1

### Patch Changes

- 51b06b3c: Fix initial media status derive
  - @pexip/media-control@17.1.1
  - @pexip/media-processor@17.1.1

## 17.1.0

### Minor Changes

- 4298b039: Allow setting default constraints to `false` Fix Audio mixing
  processor to return immediately when no main tracks

### Patch Changes

- Updated dependencies [4298b039]
- Updated dependencies [9fa7884d]
  - @pexip/media-control@17.1.0
  - @pexip/utils@16.7.0
  - @pexip/media-processor@17.1.0

## 17.0.0

### Patch Changes

- Updated dependencies [af71598]
- Updated dependencies [32c24c8d06]
- Updated dependencies [1f5d1df]
  - @pexip/media-processor@17.0.0
  - @pexip/media-control@17.0.0
  - @pexip/signal@16.5.0
  - @pexip/utils@16.6.0

## 16.7.1

### Patch Changes

- Updated dependencies [94b7f753]
  - @pexip/utils@16.6.0
  - @pexip/media-control@16.7.1
  - @pexip/media-processor@16.7.1

## 16.7.0

### Minor Changes

- 39ceb6d0: Take `MediaStreamTrack['muted']` into account for
  `Media['audioMuted']` and `Media['videoMuted']`
- cf498a4a: Remove @sentry/hub
- 20a44927: Resume AudioContext used in the audio mixer
- 0f95c333: Refactor to standardize error logging

### Patch Changes

- Updated dependencies [05ef9099]
- Updated dependencies [20a44927]
- Updated dependencies [456c06c6]
  - @pexip/media-control@16.7.0
  - @pexip/media-processor@16.7.0
  - @pexip/utils@16.5.0

## 16.6.0

### Minor Changes

- 454eda4: Derive media status from previous status to avoid going back to
  initial

  Firefox Android always revoking the permission by emptying the device label,
  this causing some unexpected behavior. With previous status, we have more
  information to derive the correct initial status.

- f8d4190238: Sync Media['devices'] on `devicechange`
- d2ad3cd13f: Fix isGranted logic to include only error
- f8d4190238: Split isGranted into isGrantedVideo and isGrantedAudio

### Patch Changes

- Updated dependencies [3ba403f688]
- Updated dependencies [f8d4190238]
- Updated dependencies [f8d4190238]
- Updated dependencies [f8d4190238]
  - @pexip/utils@16.4.1
  - @pexip/media-control@16.6.0
  - @pexip/media-processor@16.6.0

## 16.5.0

### Minor Changes

- 6225612: Remove @pexip/logger dependency

### Patch Changes

- Updated dependencies [e6ef1f2]
- Updated dependencies [6225612]
  - @pexip/utils@16.4.0
  - @pexip/media-control@16.5.0
  - @pexip/signal@16.5.0
  - @pexip/media-processor@16.5.0

## 16.4.0

### Minor Changes

- 0a57d4d: Expose Video processor processing API flag
- 6496a9d: Extract no device status

### Patch Changes

- Updated dependencies [6534b17]
- Updated dependencies [6496a9d]
- Updated dependencies [c1c3767]
  - @pexip/signal@16.4.0
  - @pexip/media-control@16.4.0
  - @pexip/media-processor@16.4.0

## 16.3.1

### Patch Changes

- Updated dependencies [4763e5b4]
  - @pexip/utils@16.3.1
  - @pexip/media-control@16.3.1
  - @pexip/media-processor@16.3.1

## 16.3.0

### Patch Changes

- @pexip/media-control@16.3.0
- @pexip/media-processor@16.3.0
- @pexip/signal@16.3.0
- @pexip/utils@16.3.0

## 16.2.0

### Patch Changes

- 3ec61611: Fix for video mute when videoProcessing is off.
  - @pexip/media-control@16.2.0
  - @pexip/media-processor@16.2.0
  - @pexip/signal@16.2.0
  - @pexip/utils@16.2.0

## 16.1.0

### Patch Changes

- @pexip/media-control@16.1.0
- @pexip/media-processor@16.1.0
- @pexip/signal@16.1.0
- @pexip/utils@16.1.0

## 16.0.0

### Patch Changes

- @pexip/media-control@16.0.0
- @pexip/media-processor@16.0.0
- @pexip/signal@16.0.0
- @pexip/utils@16.0.0

## 15.0.0

### Patch Changes

- @pexip/media-control@15.0.0
- @pexip/media-processor@15.0.0
- @pexip/signal@15.0.0
- @pexip/utils@15.0.0

## 14.1.0

### Minor Changes

- 9ac21215: Improve blur param with boundary
- 53d63e31: Force to down-mix to mono for audio mixing process

### Patch Changes

- @pexip/media-control@14.1.0
- @pexip/media-processor@14.1.0
- @pexip/signal@14.1.0
- @pexip/utils@14.1.0

## 14.0.0

### Patch Changes

- Updated dependencies [c85b88f8]
  - @pexip/media-control@14.0.0
  - @pexip/media-processor@14.0.0
  - @pexip/signal@14.0.0
  - @pexip/utils@14.0.0

## 13.2.0

### Patch Changes

- @pexip/media-processor@13.2.0
- @pexip/media-control@13.2.0
- @pexip/signal@13.2.0
- @pexip/utils@13.2.0

## 13.1.0

### Patch Changes

- @pexip/media-control@13.1.0
- @pexip/media-processor@13.1.0
- @pexip/signal@13.1.0
- @pexip/utils@13.1.0

## 13.0.0

### Patch Changes

- Updated dependencies [3750d84b]
  - @pexip/media-control@13.0.0
  - @pexip/media-processor@13.0.0
  - @pexip/signal@13.0.0
  - @pexip/utils@13.0.0

## 12.0.0

### Major Changes

- 8caca489: Remove Personify model for security reasons

### Patch Changes

- Updated dependencies [8caca489]
- Updated dependencies [52cd2cdb]
  - @pexip/media-processor@12.0.0
  - @pexip/signal@12.0.0
  - @pexip/media-control@12.0.0
  - @pexip/utils@12.0.0

## 11.0.0

### Patch Changes

- @pexip/media-control@11.0.0
- @pexip/media-processor@11.0.0
- @pexip/signal@11.0.0
- @pexip/utils@11.0.0

## 10.1.0

### Patch Changes

- @pexip/media-control@10.1.0
- @pexip/media-processor@10.1.0
- @pexip/signal@10.1.0
- @pexip/utils@10.1.0

## 10.0.0

### Patch Changes

- @pexip/media-control@10.0.0
- @pexip/media-processor@10.0.0
- @pexip/signal@10.0.0
- @pexip/utils@10.0.0

## 9.0.0

### Minor Changes

- 07fab35b: ## `edgeBlurAmount` and `backgroundBlurAmount` are a percentage of
  the processing height

  - The render parameters: `edgeBlurAmount` and `backgroundBlurAmount` are now a
    percentage of the processing height.

- 5a852b05: No unnecessary reqeust on blocked devices

### Patch Changes

- Updated dependencies [5a852b05]
  - @pexip/media-control@9.0.0
  - @pexip/media-processor@9.0.0
  - @pexip/signal@9.0.0
  - @pexip/utils@9.0.0

## 8.0.0

### Patch Changes

- @pexip/media-control@8.0.0
- @pexip/media-processor@8.0.0
- @pexip/signal@8.0.0
- @pexip/utils@8.0.0

## 7.0.0

### Minor Changes

- af8233c9: Fix the logic in tryAndGetUserMedia and
  isInitialPermissionsNotGranted. Add isInitialPermissionsGranted.
- 5d824c12: No unnecessary gUM for irrelevant device change

  ## '@pexip/media': minor

  - No unnecessary gUM for irrelevant device change

  closes https://gitlab.com/pexip/zoo/-/issues/3129

  ## '@pexip/media-control': minor

  - Add 2 new util functions
    - hasRequestingDevice,
    - shouldRequestDevice,

- efc7d2a8: Better media logging

  ## @pexip/logger

  - Add more AudioNode to log

  ## @pexip/media

  - Truncate unnecessary fields when logging with JSON

  ## @pexip/media-control

  - Put MediaDeviceInfoKind['settings'] fields into toJSON for logging

  ## @pexip/media-processor

  - Drop logger dependency and related usages

- dead15ae: Fix unplug and plug media fallback issue

  closes https://gitlab.com/pexip/zoo/-/issues/2986

  ## @pexip/media

  - Use the correct media status after release

  ## @pexip/media-control

  - Ignore ended track when validating the current device and the new constraint

### Patch Changes

- Updated dependencies [16854bc7]
- Updated dependencies [5d824c12]
- Updated dependencies [efc7d2a8]
- Updated dependencies [dead15ae]
- Updated dependencies [cbe3ccf1]
  - @pexip/utils@7.0.0
  - @pexip/media-control@7.0.0
  - @pexip/media-processor@7.0.0
  - @pexip/signal@7.0.0

## 6.0.0

### Patch Changes

- Updated dependencies [0522557c]
  - @pexip/media-processor@6.0.0
  - @pexip/media-control@6.0.0
  - @pexip/signal@6.0.0
  - @pexip/utils@6.0.0

## 5.0.0

### Minor Changes

- 9f68146d: # Presentation with audio.

  Be able to share presentation with audio.

  ## Changes on `media`

  Introduce `audioMixingProcessor` to mix audio track with additional one.

  ## Changes on `media-control`

  Introduce `mixWithAdditionalMedia` constraint.

  ## Changes on `media-components`

  Pass a cleanup `fn` to `usePresentation` hook.

  ## Changes on `media-processor`

  Add `merger` node constructor.

### Patch Changes

- Updated dependencies [2e36be80]
- Updated dependencies [9f68146d]
  - @pexip/utils@5.0.0
  - @pexip/media-control@5.0.0
  - @pexip/media-processor@5.0.0
  - @pexip/signal@5.0.0

## 4.0.0

### Minor Changes

- cf8bec29b6: # Use Streams API

  ## Changes on `media-processor`

  - Use Streams API for video processing, fallback to
    requestVideoFrameCallback/setTimeout when the API is not available
  - Turn off alpha when producing the final drawing on canvas
    - closes https://gitlab.com/pexip/zoo/-/issues/2186
  - Use desynchronized hint for canvas
  - Fix edge issue when composing blur background
  - Fix process `opened` state issue on async function

  ### Commits

  - fc398f4b38 perf(media-processor): use desynchronized hint
  - ed2d95c653 feat(media-processor): use stream transform
  - da53143a49 fix(media-processor): dom-webcodecs types
  - e271047b0f feat(media-processor): VideoProcessor accept transformers
  - eeb8992f97 feat(media-processor): add transformer creator
  - 20d085aac2 feat(media-processor): add MediaStreamTrack generator & processor
  - 096f1adc77 perf(media-processor): turn off alpha for none effect
  - a1a282c34a refactor(media-processor): move canvas related into
    canvasRenderer

  ## Changes on `media`

  - Use the latest APIs from `media-processor`
  - Fix types overridden by `dom-webcodecs`

  ### Commits

  - 0156012aab fix(media): use streams API from media-processor
  - e61ca85375 fix(media): type overrides

  ## Changes on `media-control`

  - Fix types overridden by `dom-webcodecs`

  ### Commit

  - 0a63010d20 fix(media-control): type overrides

  ## Changes on Apps

  - Use the latest APIs

  ### Commits

  - b7a768a350 feat(infinity-connect): turn on video processing for Safari
  - d05dc48b8f fix(media-processor-demo): remove comments
  - 6d58d0c987 fix(media-processor-demo): add missing await
  - 4859029594 fix(infinity-connect): apply latest changes from media
  - 3c30502ee7 fix(aquila): use latest changes from media
  - 179359a95d fix(media-demo): update settings as well
  - e3ac0cdd0e fix(media-demo): apply latest changes from media
  - f251c75f16 feat(media-processor-demo): use createCanvasTransform

  ## Others

  - Add types/dom-webcodecs

  ### Commit

  - 2458690b46 build: add types/dom-webcodecs

### Patch Changes

- Updated dependencies [d429f07df2]
- Updated dependencies [cf8bec29b6]
  - @pexip/media-processor@4.0.0
  - @pexip/media-control@4.0.0
  - @pexip/signal@4.0.0
  - @pexip/utils@4.0.0

## 3.0.0

### Major Changes

- 8e3e3b1f9: Refactor media package to follow the media constraint pattern

  https://developer.mozilla.org/en-US/docs/Web/API/Media_Streams_API/Constraints

  - Move and extend the media features based on MediaTrackConstraints by
    interpreting the provided constraints
    - Voice Activity Detection - `vad` of type `boolean`
    - Audio Signal Detection - `asd` of type `boolean`
    - Noise suppression - `denoise` (to avoid the conflict of the built-in
      `noiseSupression`) of type `boolean`, `true` means using our own impl,
      remember to disable the built-in `noiseSupression` as you don't want to
      use them both
    - Blur level - `blurLevel` of type `number`
    - Erode param - `erode` of type `number`
    - Video segmentation effects - `videoSegmentation` of type `none`, `blur`,
      `overlay` or `remove` (`remove` will be added in another MR)
  - Ad-hoc change of the features should be done via the `Media` object with the
    new `applyConstraints` API
  - `getUserMedia` is always getting a new media while applying the features
    based on the constraints when there is change to the constraints

  Example:

  ```typescript
  const constriants = {
    audio: {
      noiseSuppression: false, // Disable the built-in noise suppression
      denoise: true, // Use our own impl of noise suppression
      vad: true, // Use Voice Activity Detection
      asd: true, // Use Audio Signal Detection to check if the microphone is malfunctioned
    },
    video: {
      videoSegmentation: 'blur', // Use background blur
      erode: 1,
      blurLevel: 21,
    },
  };
  ```

  The new `MediaController` interface (removed feature-related props):

  ```typescript
  export interface MediaController {
    /**
     * Current Media if any
     */
    media: Media;
    /**
     * Current device list
     */
    devices: MediaDeviceInfoLike[];
    /**
     * Execute the media pipeline immediately with provided constraints
     *
     * @param constraints - @see MediaDeviceRequest
     */
    getUserMedia: (constraints: MediaDeviceRequest) => void;
    /**
     * Execute the media pipeline immediately with provided constraints. An
     * explicit version of `getUserMedia` to make it possible to chain other
     * async actions
     *
     * @param constraints - @see MediaDeviceRequest
     */
    getUserMediaAsync: (constraints: MediaDeviceRequest) => Promise<void>;
    /**
     * Cross-check PermissionState and available devices before requesting user
     * media, the request will be skipped if there is no granted device.
     */
    tryAndGetUserMedia: (constraints: MediaDeviceRequest) => void;
  }
  ```

  The new `Media` interface (added `applyConstraints`):

  ```typescript
  export interface Media {
    /**
     * The constraints used to request the media
     */
    constraints?: MediaDeviceRequest;
    /**
     * The devices used for the media
     */
    devices: MediaDeviceInfoLike[];
    /**
     * Media stream for the media
     */
    stream?: MediaStream;
    /**
     * The raw stream obtained from the `getUserMedia` API
     */
    rawStream?: MediaStream;
    /**
     * Audio input device is used for the audio track from the current stream
     */
    audioInput?: MediaDeviceInfoLike;
    /**
     * Video input device is used for the video track from the current stream
     */
    videoInput?: MediaDeviceInfoLike;
    /**
     * The audio input device which is expected to be used for the current
     * stream based on the provided constraints
     */
    expectedAudioInput?: MediaDeviceInfoLike;
    /**
     * The video input device which is expected to be used for the current
     * stream based on the provided constraints
     */
    expectedVideoInput?: MediaDeviceInfoLike;
    /**
     * The status of the media
     */
    status: UserMediaStatus;
    /**
     * Current mute state of audio track
     * `undefined` means there is no such track from the stream
     */
    audioMuted: boolean | undefined;
    /**
     * Current mute state of video track
     * `undefined` means there is no such track fromt the stream
     */
    videoMuted: boolean | undefined;
    /**
     * mute/unmute the audio track
     */
    muteAudio(mute: boolean): void;
    /**
     * mute/unmute the video track
     */
    muteVideo(mute: boolean): void;
    /**
     * Apply the constraints to the current media
     */
    applyConstraints(constraints: MediaDeviceRequest): Promise<void>;
    /**
     * Release the media resources, e.g. camera/microphone
     */
    release(): Promise<void>;
  }
  ```

### Minor Changes

- acedce8d8: Decouple resolution check from device check

  ## '@pexip/media-control'

  - Decouple resolution check from `isRequestedInputDevice` and add a new
    function to verify the resolution `isRequestedResolution`

  ## '@pexip/media'

  - Use `isRequestedResolution` to check the resolution to decide if we should
    request the media again

- 19b7323d5: Add background blur feature

  ## @pexip/aquila

  - Add the following flags to `config` to control the features
    - `videoSegmentation`: Enable/disable the video segmentation feature.
      Default is `false`
    - `blurLevel`: Control the blur level. Default is `7`.
    - `segmentationEffects`: The segmentation effects to use when processing the
      video. Available options are `none`, `blur` and `overlay`. Default is
      `none`, aka no effects.
  - Use the latest API from `media` package to add video segmentation feature
  - Use 640x360 size for processing
  - Keep an instance of segmentation for preview controller to avoid re-creation

  ## @pexip/bundler

  - Disable content hashing for wasm files since the way Personify SDK loads the
    wasm file is hard-coded
  - Add "babel-plugin-transform-import-meta" to fix babel-jest transform issue
    of using `import.meta`

  ## @pexip/media-demo

  - Add video segmentation feature toggle to settings for switching on/off the
    feature
  - Add video segmentation feature

  ## @pexip/media-processor-demo

  - Add image loader to load image for background overlay and effects toggle
    button
  - Add blur level selector
  - Add video segmentation feature

  ## @pexip/bg-blur

  - Add type definition
  - Add @pexip/bg-blur package to host Personify SDK

  ## @pexip/media

  - Add `videoProcessor` to media processing pipeline
  - Add lazy loading of the process for media pipeline
  - Add `blurLevel`, `frameRate`, `psySegWasmPaths`, `segmentationSize` and
    `getFeatureFlags` to `MediaOptions`
  - Expose `segmentation` for `MediaController` and `PreviewStreamController`
  - Add `getSegmentationOptions` and `videoSegmentationEnabled` to
    `PreviewStreamParams`

  ## @pexip/media-processor

  - Add video processing related modules

- 89f90433a: Upgrade Personify SDK to v1.0.3

  ## '@pexip/aquila'

  - Upgrade `@pexip/bg-blur` version
  - Add `erode` param to config

  ## '@pexip/media-demo'

  - Update accordingly

  ## '@pexip/media-processor-demo'

  - Update accordingly

  ## '@pexip/bg-blur'

  - Use Personify JS SDK v1.0.3
  - Use npm package `psyseg-js-sdk` `v1.0.6`
  - Add a workaround for yarn for `tensorflowjs` dependencies issue

  ## '@pexip/media'

  - Add `erode` property
  - Allow explicitly skipping the script loading for `PreviewController`

  ## '@pexip/media-processor'

  - Upgrade according to `@pexip/bg-blur` changes

- 3b3883832: Deprecate `AudioStatsWorklet` and consolidate VAD

  - Move `createVoiceActivityDetector` to @pexip/media-processor as
    `createVADetector`
  - Move `createAudioSignalDetector` to @pexip/media-processor
  - Renamed `isSpeakingWhileMuted` to `isVoiceActivity`
  - Remove AudioStatsWorklet and related
  - Use VAD either from denoise or analyzer, but not both

- b3cbb8a59: Fallback input device notification

  ## '@pexip/aquila'

  - Add `useFallbackDeviceNotifier` hook and use it in Preflight
  - Log the global `Notifyer` whenever there is a new toast.
  - Fix an unnecessary update of the selected inputs when media is set to
    `undefined`

  ## '@pexip/media'

  - Extract the device info and put it to
    `expectedVideoInput`/`expectedAudioInput` when we cannot find the device
    from the current device list for completeness.
  - Use `isStreamingRequestedDevices` instead of
    `isStreamingRequestedDevicesBase` to have more info about the track

  ## '@pexip/media-control'

  - Add a new utility function, `extractDeviceFromConstraints`, to extract the
    device info from the provided constraints
  - Update `isStreamingRequestedDevices` to allow passing `undefined` stream
    param.

- 57eb593c0: Be more forgiveness when comparing input devices

  When checking against the requested input device with the constraints
  provided, it is better to use the label to verify them to avoid stale
  `deviceId` issue.

  ## '@pexip/media'

  - Should always use permission granted devices to do the comparison

  ## '@pexip/media-control'

  - Use device's label to compare device when possible

- 07c09b3e2: Add background blur UIs

  ## @pexip/aquila

  - Add background blur input controls to Preflight and InMeeting The UIs are
    only be shown when the `videoSegmentation` flag is set to `true` and there
    is video track
  - When the video is muted, the segmentation effects will be set to `none` to
    avoid unnecessary processing, and the UI will be disabled

  ## @pexip/media

  - Set segmentation effects to `none` when the video is muted

- 00f9c290c: ## Support modular routing for Web Audio

  From the spec of Web Audio API, we are allowed to do
  [modular routing](https://webaudio.github.io/web-audio-api/#ModularRouting)
  which allows arbitrary connections between different `AudioNode` objects.
  However, in the initial design of our `AudioGraph`, this is not part of the
  consideration. This MR aims to fill the gap between the Web Audio API and our
  wrapper.

  With the new API, we can declare the intended connections between any
  `AudioNode`, e.g.

  ```typescript
  // Assuming we have a stereo audio input and would like visualize each channel independently
  const stream = navigator.mediaDevices.getUserMedia({audio: true});
  const source = createStreamSourceGraphNode(stream);
  const splitter = createChannelSplitterGraphNode();
  const left = createAnalyzerGraphNode();
  const right = createAnalyzerGraphNode();
  const destination = createStreamDestinationGraphNode();

  // source |-- destination
  //        |-- splitter |-- left
  //                     |-- right
  // Note: Connection Param tuple: `[AudioNodeInit, outputIndex, inputIndex]`
  const graph = createAudioGraph([
    [source, destination],
    [source, splitter],
    [[splitter, 0, 0], left], // Connect the output#0 of the splitter to the `left` analyzer
    [[splitter, 1, 0], right], // Connect the output#1 of the splitter to the `right` analyzer
  ]);

  // Later if you want to disconnect the analyzers
  graph.disconnect([source, splitter]);
  // Or connect the splitter again
  graph.connect([source, splitter]);
  // Check if there is any connection between 2 nodes
  source.hasConnectedTo(splitter); // Expect `true` if they are connected, otherwise `false`
  ```

  ## Other notable changes

  - Add `createChannelSplitterGraphNode`
  - Add `AudioNodeInitConnectParam` for declaring the connection
  - Remove `workletModules` from `AudioGraphOptions`
  - Expose `AudioGraph['addWorklet']`

- 7e7dcfa30: Properly update the cache when the resolution changes

### Patch Changes

- Updated dependencies [0a054710b]
- Updated dependencies [acedce8d8]
- Updated dependencies [19b7323d5]
- Updated dependencies [89f90433a]
- Updated dependencies [3b3883832]
- Updated dependencies [b3cbb8a59]
- Updated dependencies [57eb593c0]
- Updated dependencies [8e3e3b1f9]
- Updated dependencies [d62f2a28d]
- Updated dependencies [00f9c290c]
- Updated dependencies [730082765]
- Updated dependencies [048e384e7]
  - @pexip/media-control@2.1.0
  - @pexip/media-processor@3.0.0
  - @pexip/utils@2.1.0
  - @pexip/signal@2.0.1

## 2.0.0

### Minor Changes

- 0430bbad2: ## '@pexip/media'

  Add mute state and related events

  - Add `audioMuted` and `videoMuted`
  - Connect `MediaStreamTrack` native events to signals
  - Add and connect `onStreamTrackEnabled` signal
  - Refactor `buildMedia`

  ## '@pexip/media-demo'

  Add mute state and related logics

  ## '@pexip/media-control'

  Change `createStreamTrackEventSubscriptions` to accept track instead of
  stream.

- 7b2228e7b: Fix Settings flash issue caused by empty device ID
- 6fca55cbe: Fix media leak issues from Settings
- 0430bbad2: Allow mute state to be undefined
- cf2493ea9: Fix blocked device selection issues

  ## @pexip/aquila

  - Add i18n to `DeviceSelect` component
  - Use `MissDeviceAlert` component only when there is denied device or no
    device available for selection

  ## @pexip/components

  - Add `errorTextId` prop to `Select` component for testing

  ## @pexip/media

  - Add more props to Media

    Add `status`, `expectedAudioInput`, `expectedVideoInput`, `constraints` to
    `Media`

  ## @pexip/media-control

  - Add `findDeviceFromDeviceConstraints` util

    Find device from the device list with provided constraints, i.e.
    `InputDeviceConstraint` -> `MediaDeviceInfoLike | true | undefined`. It
    returns `true` meaning that it can be any devices, `undefined` means device
    not found, otherwise, the matched device will be returned

- 07caf0c47: Fix behavior signal `onDeviceChanged` issue

  ## General

  The behavior signal of `onDevicesChanged` can
  [cause problem](https://gitlab.com/pexip/zoo/-/issues/1780) when there is no
  device at all.

  Indeed, there is no need to use a behaving signal, a generic one is good
  enough for our usecase of `onDevicesChanged`. What we need to do before we
  initiate the initial `getUserMedia` is to cross-check with the
  `PermissionState` and the `devices`, and thus `tryAndGetUserMedia` API is
  introduced to do the job.

  ## Changes

  ### fix(aquila): use preflight page to trigger media request

  - Change `onDevicesChanged` to a `generic` signal, instead of `behavior`
  - Use Preflight to trigger media request

  closes https://gitlab.com/pexip/zoo/-/issues/1780

  ### feat(aquila): add useGetUserMedia hook

  - Add `useGetUserMedia` hook to trigger permission validation and initiate
    media request

  ### feat(media): new tryAndGetUserMedia API

  - Add `tryAndGetUserMedia`
  - Check if there is any actual changes of devices

  ### refactor(media-control): for re-usability

  - Refactor `createTrackDevicesChanges` to allow passing initial state

- 055c1d42f: # Fix incorrect selected device in Preflight device selector

  When the media input device stored in the `localStorage` is stale, the
  selected device from the `DeviceSelector` failed to show the correct selected
  input. This is because we was passing the input config from the `localStorage`
  directly to the `DeviceSelector` component and under some situation the
  persisted input device preferences are no longer valid. e.g. Buy a new device
  of the same model, OS/System update causing the change of `deviceId`, etc.

  ## Steps to reproduce the issue

  1. Save your preference of the device from the App Settings/Preflight.
  1. Change the deviceId from the `localStorage`:
     `aquila:videoInpiut`/`aquila:audioInput` to simulate the change of
     `deviceId`
  1. Refresh the page, and then check the device selectors

  ## Expected behavior

  The Device selector should correctly show the device in-use

  # Fix stale device list issue in Firefox

  In Firefox, the life of granted devices can only live as long as the media
  stream session, when the stream is released, all the granted devices are
  revoked, i.e. the label will be empty again. However, the media package does
  not capture this behavior. This causes inconsistent UIs from the Selfview and
  the Device selection list.

  ## Steps to reproduce the issue

  1. Go to Preflight
  1. Click "Request permissions" button
  1. Go back to dashboard, and then start a new meeting.

  ## Expected behavior

  The Device selector should show "Waiting for permissions..." when the
  permission is not granted.

  # Changes

  ## @pexip/media

  - Update `devices` prop when the status is `InitialPermissionNotGranted` to
    avoid caching the outdated device list
  - Move `resolveInput` from `aquila` into `media` package

  ## @pexip/aquila

  - Fix incorrect selected device in Preflight device selector
  - Fix stale device list issue in Firefox

  ## @pexip/media-control

  - Enhance `mergeConstraints` utility to accept `InputDeviceConstraint`

- 6fca55cbe: Fix a future media release issue
- b0406fb6f: Mute with MediaStreamTrack['enabled'] instead of GainNode
- 329125c70: Fix active input device and new request constraints comparison

  - Always use the latest device list when accessing the
    `audioInput`/`videoInput` props from `Media`
  - Remove fallback to `MediaStreamTrack` when accessing
    `audioInput`/`videoInput` props from `Media` when doing comparison between
    the active stream and new request

- 0430bbad2: Log muteAudio and muteVideo with track info
- 02d093bd3: Invalidate input cache when the related track is not live
- a0b8d9a6f: ## fix(aquila): avoid muting something which does not exists

  Verify before we call the media mute functions

  ## fix(media): the track will be enabled from the processor

  Only mute when there is a track to mute to

- ed6b2d90e: Fix guessing error by elimination

  We guess the media request error by eliminating the audio and video
  constraints, if we cannot get a stream with the provided constraints. e.g.
  instead of getting `PermissionsOnlyAudioinput` when there is an error with the
  video input when requesting the device, the status for this will be
  `VideoDeviceInUse`, if the error is `NotReadableError`.

  Add the following `UserMediaStatus`

  - `Overconstrained`
  - `VideoOverconstrained`
  - `AudioOverconstrained`
  - `InvalidConstraints`
  - `InvalidVideoConstraints`
  - `InvalidAudioConstraints`
  - `NotSupportedError`
  - `NotSupportedErrorOnlyVideoInput`
  - `NotSupportedErrorOnlyAudioInput`

- 329125c70: Use exact constraints for preview controller
- c1bf7f05c: Remove duplicated devices before checking changes

  - Extract the logic to track device changes, and add unit test cases
  - Remove duplicated devices when tracking changes from `devicechange` event
  - Use `MediaDeviceInfoLike` instead `MediaDeviceInfo` for related events

  A bug from Firefox (v88.0.1) 64-bit or above, there is chance that the devices
  we get from the API `enumerateDevices` are not unique with particular devices,
  e.g. Logitech BRIO. Since we are relying on the uniqueness for tracking the
  changes of device to fire `devices:found` or `devices:lost` events, this
  causes all the operations relying on these events, e.g. false positive
  `devices:found` event.

  See https://gitlab.com/pexip/zoo/-/issues/1743

- f3a8057f4: Add rawStream to Media and usee raw MediaStream when available for
  preview controller
- 29741a2d4: Log improvement and audio click fix

  ## '@pexip/logger'

  - Add what to log AnalyserNode

  ## '@pexip/media'

  - Remove unnecessary sync of audio mute
  - Add more logs
  - Add docs

  ## '@pexip/media-processor'

  - Reverse the release order to avoid click

### Patch Changes

- 94a86d3c7: add states for no video devices during audio detection
- 839436f8d: ## @pexip/media

  - Only use `error` level when on the following errors when requesting media,
    otherwise, `warn` level

    - `TypeError`
    - `NotSupportedError`
    - `UnknownError`
    - `OverconstrainedError` (when it is not `exact` device request)

  ## @pexip/media-control

  - Add `isExactDeviceConstraint` utility to check if the provided constraint is
    an exact constraint

- Updated dependencies [0430bbad2]
- Updated dependencies [281f3afbe]
- Updated dependencies [2655f552f]
- Updated dependencies [649e27941]
- Updated dependencies [cf2493ea9]
- Updated dependencies [07caf0c47]
- Updated dependencies [31c667453]
- Updated dependencies [6ddadd2e5]
- Updated dependencies [89ef2b1aa]
- Updated dependencies [839436f8d]
- Updated dependencies [029f5fb8a]
- Updated dependencies [5ad1a1e92]
- Updated dependencies [c1bf7f05c]
- Updated dependencies [29741a2d4]
- Updated dependencies [72641f2cd]
  - @pexip/media-control@2.0.0
  - @pexip/media-processor@2.0.0
  - @pexip/signal@2.0.0
