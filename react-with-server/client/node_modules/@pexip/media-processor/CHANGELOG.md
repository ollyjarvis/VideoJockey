# Changelog

## 18.3.0

## 18.2.0

### Patch Changes

- Updated dependencies [6cb27d9]
  - @pexip/utils@16.12.0

## 18.1.0

### Minor Changes

- b818713: Bump @mediapipe/tasks-vision to v0.10.14 and remove workaround for
  WebWorker issue

## 18.0.0

### Major Changes

- bfb8058: Replace @mediapipe/selfie_segmentation with @mediapipe/tasks-vision

  - Replace @mediapipe/selfie_segmentation with @mediapipe/tasks-vision
  - Move video processing into WebWorker
  - Replace Canvas 2D with WebGL implementation
  - Replace Gaussian Blur with Dual filtering blur
  - Add Segmentation Mask Smoothing

### Minor Changes

- 0a5a136: Fix getting the correct size of the MediaStream from a video element
- 6b75621: Return the processing result when no output provided
- 218a2c0: Refactor lazy props
- 9bcfc68: Avoid processing a frame which is disposed
- 1543a66: Allow passing Background Image Binary

  - Add `update()` API to allow passing Background Image for background
    replacement

- 68e8ec1: Standardize input size and ratio

### Patch Changes

- Updated dependencies [bfb8058]
  - @pexip/utils@16.11.0

## 17.4.0

### Minor Changes

- 24fe7e1: Fix lint related errors

### Patch Changes

- Updated dependencies [4a1908a]
- Updated dependencies [fec1c90]
- Updated dependencies [ec134d1]
- Updated dependencies [24fe7e1]
  - @pexip/utils@16.10.0
  - @pexip/denoise@16.4.0

## 17.3.0

### Minor Changes

- 68c3ba1bb8: Fix VideoFrame type issue

### Patch Changes

- 96f3ce8802: Typescript and tests updates after `yarn.lock` file maintenance
- Updated dependencies [7b29d953]
  - @pexip/utils@16.9.0

## 17.2.0

### Minor Changes

- c418c778: Performance optimization for blur effect with down scaling

### Patch Changes

- Updated dependencies [244cb04c]
- Updated dependencies [4ea55a5205]
  - @pexip/utils@16.8.0
  - @pexip/denoise@16.3.1

## 17.1.2

## 17.1.1

## 17.1.0

### Patch Changes

- Updated dependencies [9fa7884d]
  - @pexip/utils@16.7.0

## 17.0.0

### Major Changes

- 1f5d1df: Restructure to allow targeting to differernt environments

### Minor Changes

- af71598: Avoid using desynconized 2D cavas because MS Edge 113 on Windows
  produces green screen
- 32c24c8d06: Remove bg-blur dependency

### Patch Changes

- @pexip/utils@16.6.0

## 16.7.1

### Patch Changes

- Updated dependencies [94b7f753]
  - @pexip/utils@16.6.0

## 16.7.0

### Minor Changes

- 20a44927: React on unmute track to resume suspended AudioContext

### Patch Changes

- Updated dependencies [456c06c6]
  - @pexip/utils@16.5.0

## 16.6.0

### Patch Changes

- Updated dependencies [3ba403f688]
  - @pexip/utils@16.4.1

## 16.5.0

### Patch Changes

- Updated dependencies [e6ef1f2]
  - @pexip/utils@16.4.0

## 16.4.0

### Minor Changes

- c1c3767: Avoid error when there is no MediaSource available

### Patch Changes

- Updated dependencies [c71c68f]
  - @pexip/bg-blur@16.4.0

## 16.3.1

### Patch Changes

- Updated dependencies [4763e5b4]
  - @pexip/utils@16.3.1

## 16.3.0

### Patch Changes

- @pexip/bg-blur@16.3.0
- @pexip/denoise@16.3.0
- @pexip/utils@16.3.0

## 16.2.0

### Patch Changes

- @pexip/bg-blur@16.2.0
- @pexip/denoise@16.2.0
- @pexip/utils@16.2.0

## 16.1.0

### Patch Changes

- @pexip/bg-blur@16.1.0
- @pexip/denoise@16.1.0
- @pexip/utils@16.1.0

## 16.0.0

### Patch Changes

- @pexip/bg-blur@16.0.0
- @pexip/denoise@16.0.0
- @pexip/utils@16.0.0

## 15.0.0

### Patch Changes

- @pexip/bg-blur@15.0.0
- @pexip/denoise@15.0.0
- @pexip/utils@15.0.0

## 14.1.0

### Patch Changes

- @pexip/bg-blur@14.1.0
- @pexip/denoise@14.1.0
- @pexip/utils@14.1.0

## 14.0.0

### Patch Changes

- @pexip/bg-blur@14.0.0
- @pexip/denoise@14.0.0
- @pexip/utils@14.0.0

## 13.2.0

### Patch Changes

- Updated dependencies [f450282b]
  - @pexip/bg-blur@13.2.0
  - @pexip/denoise@13.2.0
  - @pexip/utils@13.2.0

## 13.1.0

### Patch Changes

- @pexip/bg-blur@13.1.0
- @pexip/denoise@13.1.0
- @pexip/utils@13.1.0

## 13.0.0

### Patch Changes

- @pexip/bg-blur@13.0.0
- @pexip/denoise@13.0.0
- @pexip/utils@13.0.0

## 12.0.0

### Major Changes

- 8caca489: Remove Personify model for security reasons

### Patch Changes

- Updated dependencies [8caca489]
  - @pexip/bg-blur@12.0.0
  - @pexip/denoise@12.0.0
  - @pexip/utils@12.0.0

## 11.0.0

### Patch Changes

- @pexip/bg-blur@11.0.0
- @pexip/denoise@11.0.0
- @pexip/utils@11.0.0

## 10.1.0

### Patch Changes

- @pexip/bg-blur@10.1.0
- @pexip/denoise@10.1.0
- @pexip/utils@10.1.0

## 10.0.0

### Patch Changes

- @pexip/bg-blur@10.0.0
- @pexip/denoise@10.0.0
- @pexip/utils@10.0.0

## 9.0.0

### Patch Changes

- @pexip/bg-blur@9.0.0
- @pexip/denoise@9.0.0
- @pexip/utils@9.0.0

## 8.0.0

### Patch Changes

- @pexip/bg-blur@8.0.0
- @pexip/denoise@8.0.0
- @pexip/utils@8.0.0

## 7.0.0

### Minor Changes

- efc7d2a8: Better media logging

  ## @pexip/logger

  - Add more AudioNode to log

  ## @pexip/media

  - Truncate unnecessary fields when logging with JSON

  ## @pexip/media-control

  - Put MediaDeviceInfoKind['settings'] fields into toJSON for logging

  ## @pexip/media-processor

  - Drop logger dependency and related usages

- cbe3ccf1: Ensure to resolve play video promise

### Patch Changes

- Updated dependencies [16854bc7]
  - @pexip/utils@7.0.0
  - @pexip/bg-blur@7.0.0
  - @pexip/denoise@7.0.0

## 6.0.0

### Minor Changes

- 0522557c: Fix older version AbortSignal

  AbortSignal['reason'] is supported from Chromium v98 and Firefox v97. Before
  that, there is no way to identify the abort reason so we should simply ignore
  this abort error. Ref.
  https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal#browser_compatibility
  closes #3158

### Patch Changes

- @pexip/bg-blur@6.0.0
- @pexip/denoise@6.0.0
- @pexip/logger@6.0.0
- @pexip/utils@6.0.0

## 5.0.0

### Minor Changes

- 9f68146d: # Presentation with audio.

  Be able to share presentation with audio.

  ## Changes on `media`

  Introduce `audioMixingProcessor` to mix audio track with additional one.

  ## Changes on `media-control`

  Introduce `mixWithAdditionalMedia` constraint.

  ## Changes on `media-components`

  Pass a cleanup `fn` to `usePresentation` hook.

  ## Changes on `media-processor`

  Add `merger` node constructor.

### Patch Changes

- Updated dependencies [2e36be80]
  - @pexip/utils@5.0.0
  - @pexip/bg-blur@5.0.0
  - @pexip/denoise@5.0.0
  - @pexip/logger@5.0.0

## 4.0.0

### Major Changes

- cf8bec29b6: # Use Streams API

  ## Changes on `media-processor`

  - Use Streams API for video processing, fallback to
    requestVideoFrameCallback/setTimeout when the API is not available
  - Turn off alpha when producing the final drawing on canvas
    - closes https://gitlab.com/pexip/zoo/-/issues/2186
  - Use desynchronized hint for canvas
  - Fix edge issue when composing blur background
  - Fix process `opened` state issue on async function

  ### Commits

  - fc398f4b38 perf(media-processor): use desynchronized hint
  - ed2d95c653 feat(media-processor): use stream transform
  - da53143a49 fix(media-processor): dom-webcodecs types
  - e271047b0f feat(media-processor): VideoProcessor accept transformers
  - eeb8992f97 feat(media-processor): add transformer creator
  - 20d085aac2 feat(media-processor): add MediaStreamTrack generator & processor
  - 096f1adc77 perf(media-processor): turn off alpha for none effect
  - a1a282c34a refactor(media-processor): move canvas related into
    canvasRenderer

  ## Changes on `media`

  - Use the latest APIs from `media-processor`
  - Fix types overridden by `dom-webcodecs`

  ### Commits

  - 0156012aab fix(media): use streams API from media-processor
  - e61ca85375 fix(media): type overrides

  ## Changes on `media-control`

  - Fix types overridden by `dom-webcodecs`

  ### Commit

  - 0a63010d20 fix(media-control): type overrides

  ## Changes on Apps

  - Use the latest APIs

  ### Commits

  - b7a768a350 feat(infinity-connect): turn on video processing for Safari
  - d05dc48b8f fix(media-processor-demo): remove comments
  - 6d58d0c987 fix(media-processor-demo): add missing await
  - 4859029594 fix(infinity-connect): apply latest changes from media
  - 3c30502ee7 fix(aquila): use latest changes from media
  - 179359a95d fix(media-demo): update settings as well
  - e3ac0cdd0e fix(media-demo): apply latest changes from media
  - f251c75f16 feat(media-processor-demo): use createCanvasTransform

  ## Others

  - Add types/dom-webcodecs

  ### Commit

  - 2458690b46 build: add types/dom-webcodecs

### Patch Changes

- d429f07df2: ### Changes

  733b6c099f chore(deps): update react monorepo to v18 (major) d59cd19c89
  perf(media-processor): use image size d642488120 perf(media-processor): more
  canvas tweaks 348e0ebbb2 perf(media-processor): skip edge blurring
  optimization 59d6fa8cce feat(media-processor): use requestVideoFrameCallback
  e97aeec800 fix(media-processor): use input resolution on canvas when
  processing is not applied 972f4b8109 fix(deps): update rust crate nnnoiseless
  to 0.4.0 df6972a4f4 Merge branch 'renovate/getrandom-0.x' into 'main'
  5527c14276 fix(deps): update rust crate getrandom to 0.2.6 11a4eb2a00
  chore(deps): update rust crate wasm-bindgen-test to 0.3.30 6a2e06cdb4
  fix(media): bgImageUrl constraint feature d285413fcb
  feat(media,media-processor): add facemesh 0b8a98a71b chore(deps): update
  dependency typescript to ~4.6.0 8fba551b62 build: bump @pexip/ 0ecad34992
  refactor(aquila): move Settings logic to useSettingsModal and move to
  media-components d6a8a63dcc fix(deps): update rust crate rand_distr to 0.4.3
  923f4a571d chore(deps): lock file maintenance 4c482279eb fix(deps): update
  dependency typescript to ~4.5.5 dc4778a8e0 Merge branch
  'renovate/wasm-bindgen-test-0.x' into 'main' 1bd8cc1728 Merge branch
  'renovate/rand-0.x' into 'main' 0a314afb50 Merge branch
  'renovate/getrandom-0.x' into 'main' f143902ee5 Selfie segmentation
  integration eaab7b6bff build: build workspace with turbo 764ce1b085 fix(deps):
  update rust crate getrandom to 0.2.5 e2b67c02bf chore(deps): lock file
  maintenance 2176590e3a fix(deps): update rust crate rand to 0.8.5 87444b046c
  chore(deps): lock file maintenance 9dc8d65577 fix(media-processor): AudioNode
  related issues 1ed12aba0b chore: update, normalize, and sort all package.json
  files b64030565a feat(infinity-connect): one time flow first cut 00f9c290c0
  feat(media-processor): support multi connect audio node 09dd205f0c
  chore(deps): update rust crate wasm-bindgen-test to 0.3.29 e1ada64e65
  fix(deps): update rust crate console_error_panic_hook to 0.1.7 6856a69269
  fix(media-processor): band-aid to fix storybook deb6609b59 feat(media): Add
  AudioDestionationNodeInit and DelayNodeInit a96bd188e9 feat(media): add
  background overlay and removal 8e3e3b1f98 refactor(media): follow the follow
  media constraints pattern b0b1e1bce2 build(media-processor): upgrade
  nnnoiseless to v0.3.3 e5002561db build(aquila): build and dev with vite

  - @pexip/bg-blur@4.0.0
  - @pexip/denoise@4.0.0
  - @pexip/logger@4.0.0
  - @pexip/utils@4.0.0

## 3.0.0

### Major Changes

- 3b3883832: Deprecate `AudioStatsWorklet` and consolidate VAD

  - Move `createVoiceActivityDetector` to @pexip/media-processor as
    `createVADetector`
  - Move `createAudioSignalDetector` to @pexip/media-processor
  - Renamed `isSpeakingWhileMuted` to `isVoiceActivity`
  - Remove AudioStatsWorklet and related
  - Use VAD either from denoise or analyzer, but not both

- 00f9c290c: ## Support modular routing for Web Audio

  From the spec of Web Audio API, we are allowed to do
  [modular routing](https://webaudio.github.io/web-audio-api/#ModularRouting)
  which allows arbitrary connections between different `AudioNode` objects.
  However, in the initial design of our `AudioGraph`, this is not part of the
  consideration. This MR aims to fill the gap between the Web Audio API and our
  wrapper.

  With the new API, we can declare the intended connections between any
  `AudioNode`, e.g.

  ```typescript
  // Assuming we have a stereo audio input and would like visualize each channel independently
  const stream = navigator.mediaDevices.getUserMedia({audio: true});
  const source = createStreamSourceGraphNode(stream);
  const splitter = createChannelSplitterGraphNode();
  const left = createAnalyzerGraphNode();
  const right = createAnalyzerGraphNode();
  const destination = createStreamDestinationGraphNode();

  // source |-- destination
  //        |-- splitter |-- left
  //                     |-- right
  // Note: Connection Param tuple: `[AudioNodeInit, outputIndex, inputIndex]`
  const graph = createAudioGraph([
    [source, destination],
    [source, splitter],
    [[splitter, 0, 0], left], // Connect the output#0 of the splitter to the `left` analyzer
    [[splitter, 1, 0], right], // Connect the output#1 of the splitter to the `right` analyzer
  ]);

  // Later if you want to disconnect the analyzers
  graph.disconnect([source, splitter]);
  // Or connect the splitter again
  graph.connect([source, splitter]);
  // Check if there is any connection between 2 nodes
  source.hasConnectedTo(splitter); // Expect `true` if they are connected, otherwise `false`
  ```

  ## Other notable changes

  - Add `createChannelSplitterGraphNode`
  - Add `AudioNodeInitConnectParam` for declaring the connection
  - Remove `workletModules` from `AudioGraphOptions`
  - Expose `AudioGraph['addWorklet']`

### Minor Changes

- 19b7323d5: Add background blur feature

  ## @pexip/aquila

  - Add the following flags to `config` to control the features
    - `videoSegmentation`: Enable/disable the video segmentation feature.
      Default is `false`
    - `blurLevel`: Control the blur level. Default is `7`.
    - `segmentationEffects`: The segmentation effects to use when processing the
      video. Available options are `none`, `blur` and `overlay`. Default is
      `none`, aka no effects.
  - Use the latest API from `media` package to add video segmentation feature
  - Use 640x360 size for processing
  - Keep an instance of segmentation for preview controller to avoid re-creation

  ## @pexip/bundler

  - Disable content hashing for wasm files since the way Personify SDK loads the
    wasm file is hard-coded
  - Add "babel-plugin-transform-import-meta" to fix babel-jest transform issue
    of using `import.meta`

  ## @pexip/media-demo

  - Add video segmentation feature toggle to settings for switching on/off the
    feature
  - Add video segmentation feature

  ## @pexip/media-processor-demo

  - Add image loader to load image for background overlay and effects toggle
    button
  - Add blur level selector
  - Add video segmentation feature

  ## @pexip/bg-blur

  - Add type definition
  - Add @pexip/bg-blur package to host Personify SDK

  ## @pexip/media

  - Add `videoProcessor` to media processing pipeline
  - Add lazy loading of the process for media pipeline
  - Add `blurLevel`, `frameRate`, `psySegWasmPaths`, `segmentationSize` and
    `getFeatureFlags` to `MediaOptions`
  - Expose `segmentation` for `MediaController` and `PreviewStreamController`
  - Add `getSegmentationOptions` and `videoSegmentationEnabled` to
    `PreviewStreamParams`

  ## @pexip/media-processor

  - Add video processing related modules

- 89f90433a: Upgrade Personify SDK to v1.0.3

  ## '@pexip/aquila'

  - Upgrade `@pexip/bg-blur` version
  - Add `erode` param to config

  ## '@pexip/media-demo'

  - Update accordingly

  ## '@pexip/media-processor-demo'

  - Update accordingly

  ## '@pexip/bg-blur'

  - Use Personify JS SDK v1.0.3
  - Use npm package `psyseg-js-sdk` `v1.0.6`
  - Add a workaround for yarn for `tensorflowjs` dependencies issue

  ## '@pexip/media'

  - Add `erode` property
  - Allow explicitly skipping the script loading for `PreviewController`

  ## '@pexip/media-processor'

  - Upgrade according to `@pexip/bg-blur` changes

- 8e3e3b1f9: Refactor media package to follow the media constraint pattern

  https://developer.mozilla.org/en-US/docs/Web/API/Media_Streams_API/Constraints

  - Move and extend the media features based on MediaTrackConstraints by
    interpreting the provided constraints
    - Voice Activity Detection - `vad` of type `boolean`
    - Audio Signal Detection - `asd` of type `boolean`
    - Noise suppression - `denoise` (to avoid the conflict of the built-in
      `noiseSupression`) of type `boolean`, `true` means using our own impl,
      remember to disable the built-in `noiseSupression` as you don't want to
      use them both
    - Blur level - `blurLevel` of type `number`
    - Erode param - `erode` of type `number`
    - Video segmentation effects - `videoSegmentation` of type `none`, `blur`,
      `overlay` or `remove` (`remove` will be added in another MR)
  - Ad-hoc change of the features should be done via the `Media` object with the
    new `applyConstraints` API
  - `getUserMedia` is always getting a new media while applying the features
    based on the constraints when there is change to the constraints

  Example:

  ```typescript
  const constriants = {
    audio: {
      noiseSuppression: false, // Disable the built-in noise suppression
      denoise: true, // Use our own impl of noise suppression
      vad: true, // Use Voice Activity Detection
      asd: true, // Use Audio Signal Detection to check if the microphone is malfunctioned
    },
    video: {
      videoSegmentation: 'blur', // Use background blur
      erode: 1,
      blurLevel: 21,
    },
  };
  ```

  The new `MediaController` interface (removed feature-related props):

  ```typescript
  export interface MediaController {
    /**
     * Current Media if any
     */
    media: Media;
    /**
     * Current device list
     */
    devices: MediaDeviceInfoLike[];
    /**
     * Execute the media pipeline immediately with provided constraints
     *
     * @param constraints - @see MediaDeviceRequest
     */
    getUserMedia: (constraints: MediaDeviceRequest) => void;
    /**
     * Execute the media pipeline immediately with provided constraints. An
     * explicit version of `getUserMedia` to make it possible to chain other
     * async actions
     *
     * @param constraints - @see MediaDeviceRequest
     */
    getUserMediaAsync: (constraints: MediaDeviceRequest) => Promise<void>;
    /**
     * Cross-check PermissionState and available devices before requesting user
     * media, the request will be skipped if there is no granted device.
     */
    tryAndGetUserMedia: (constraints: MediaDeviceRequest) => void;
  }
  ```

  The new `Media` interface (added `applyConstraints`):

  ```typescript
  export interface Media {
    /**
     * The constraints used to request the media
     */
    constraints?: MediaDeviceRequest;
    /**
     * The devices used for the media
     */
    devices: MediaDeviceInfoLike[];
    /**
     * Media stream for the media
     */
    stream?: MediaStream;
    /**
     * The raw stream obtained from the `getUserMedia` API
     */
    rawStream?: MediaStream;
    /**
     * Audio input device is used for the audio track from the current stream
     */
    audioInput?: MediaDeviceInfoLike;
    /**
     * Video input device is used for the video track from the current stream
     */
    videoInput?: MediaDeviceInfoLike;
    /**
     * The audio input device which is expected to be used for the current
     * stream based on the provided constraints
     */
    expectedAudioInput?: MediaDeviceInfoLike;
    /**
     * The video input device which is expected to be used for the current
     * stream based on the provided constraints
     */
    expectedVideoInput?: MediaDeviceInfoLike;
    /**
     * The status of the media
     */
    status: UserMediaStatus;
    /**
     * Current mute state of audio track
     * `undefined` means there is no such track from the stream
     */
    audioMuted: boolean | undefined;
    /**
     * Current mute state of video track
     * `undefined` means there is no such track fromt the stream
     */
    videoMuted: boolean | undefined;
    /**
     * mute/unmute the audio track
     */
    muteAudio(mute: boolean): void;
    /**
     * mute/unmute the video track
     */
    muteVideo(mute: boolean): void;
    /**
     * Apply the constraints to the current media
     */
    applyConstraints(constraints: MediaDeviceRequest): Promise<void>;
    /**
     * Release the media resources, e.g. camera/microphone
     */
    release(): Promise<void>;
  }
  ```

- d62f2a28d: Fix buffer type def

  ## '@pexip/bg-blur'

  - PsySegBuf['data'] can be `null`

  ## '@pexip/media-processor'

  - Avoid drawing something doesn't exist

    When there is no data is written into the output buffer, (possibly a bug
    from the Personify), we should avoid drawing, and just log the incidence.

- 730082765: Enable video segmentation

  ## @pexip/aquila

  - Enable video segmentation for Chrome (not running from mobile)
  - Persist blur effects when it is in Preflight

  ## @pexip/media-processor-demo

  - Cleanup

  ## @pexip/media-processor

  - Refactor and add more logs

### Patch Changes

- Updated dependencies [19b7323d5]
- Updated dependencies [89f90433a]
- Updated dependencies [3b3883832]
- Updated dependencies [d62f2a28d]
- Updated dependencies [46b70ba43]
  - @pexip/bg-blur@1.1.0
  - @pexip/utils@2.1.0
  - @pexip/logger@2.1.0

## 2.0.0

### Minor Changes

- 2655f552f: Add timeout delay constant to Analyzer timeout subscription
- 29741a2d4: Log improvement and audio click fix

  ## '@pexip/logger'

  - Add what to log AnalyserNode

  ## '@pexip/media'

  - Remove unnecessary sync of audio mute
  - Add more logs
  - Add docs

  ## '@pexip/media-processor'

  - Reverse the release order to avoid click

### Patch Changes

- Updated dependencies [29741a2d4]
- Updated dependencies [958250434]
- Updated dependencies [04752bc9d]
- Updated dependencies [945ca1989]
- Updated dependencies [29741a2d4]
  - @pexip/logger@2.0.0
  - @pexip/utils@2.0.0

## 1.4.0

### Minor Changes

- 5c9120efd: Track changes using changesets

### Patch Changes

- Updated dependencies [5c9120efd]
  - @pexip/denoise@1.4.0
  - @pexip/logger@1.4.0
  - @pexip/utils@1.4.0

## [0.10.7] - 2021-03-11

### Fixed

- Add a guard to avoid `TypeError: The provided value is non-finite`
- A potential a node is removed but not disconnected

## [0.10.6] - 2021-03-08

### Changed

- Separate states per channel for denoise processing

### Added

- Add `build:denoise` script to build denoise wasm

## [0.10.5] - 2021-03-07

## Fixed

- don't use stale audio context state in onstatechange [#3750]

## [0.10.4] - 2021-03-04

## Fixed

- Add guard in async `insertNode` to avoid `InvalidAccessError`

## [0.10.3] - 2021-03-03

## Fixed

- Should not include `AudioWorkletProcessor` in the `hasAudioWorklet()` check

## [0.10.2] - 2021-03-03

## Fixed

- Log Proxied method only when it is called
- Return `false` to set trap to avoid change to the target properties

## [0.10.1] - 2021-03-03

## Fixed

- Logging the lifecycle

## Added

- Add an option to pass `AudioContext` to `AudioGraph`
- Export `createAudioContext` utility

## [0.10.0] - 2021-03-02

### Fixed

- `AudioWorklet` browser compatibility issues

### Added

- `AudioGraph['insertNode']`

  `AudioGraph` is changed to be built in 2 phases if there is any `Worklet` node
  needed:

  - Phase 1: Build and connect Native `AudioNode`
  - Phase 2: Add `AudioWorklet` module and then insert the `AudioWorkletNode`
    into the graph when the `Worklet` is ready (`async`)

- `createAudioStatsGraphNode`: A wrapper to either create an
  `AudioStatsWorkletNodeInit` or `AnalyzerNodeInit`

### Removed

- **Breaking Change**: `AudioGraph['addNode']` is removed, use
  `AudioGraph['insertNode']` instead

### Changed

- Use Proxy for `AudioNodeInit` creation
- Rename `createAudioStatsGraphNode` to `createAudioStatsAnalyzerGraphNode`

## [0.9.1] - 2021-02-26

### Fixed

- Fix accessor issues for AudioNodeInit creation

## [0.9.0] - 2021-02-24

### Changed

- Rename to `@pexip/media-processor`
- Remove `api-extractor` and related
- Refactor the package for scalability and flexibility

  Changed **from**

  ```typescript
  const fftSize = 64;
  const analyser = createAudioAnalyzer(stream, {controlGain: true, fftSize});
  analyzer.setMute(true); // to mute
  analyzer.mute; // to get the mute state

  analyzer.stream; // to get the stream

  const buffer = new Float32Array(fftSize);
  const volume = analyzer.getAverageVolume(buffer); // to get the average volume

  await analyzer.release();
  ```

  **to**

  ```typescript
  const fftSize = 64;
  const source = createStreamSourceGraphNode(stream);
  const analyzer = createAnalyzerGraphNode({fftSize});
  const gain = createGainGraphNode(false);
  const destination = createStreamDestinationGraphNode();
  const graph = createAudioGraph([source, analyzer, gain, destination]);

  if (gain.node) {
    gain.node.mute = true; // to mute
  }
  gain.node?.mute; // get the mute state

  destination.node.stream; // to get the stream

  const buffer = new Float32Array(fftSize);
  const volume = analyzer.node?.getAverageVolume(buffer); // to get the average volume

  await graph.release();
  ```

### Added

- Denoise wasm module and AudioWorklet for noise suppression

  - Add a sub folder, `denoise` to host the source code of denoise WebAssembly

- APIs to create `AudioNodeInit` for building the `AudioGraph`

  - `createStreamSourceGraphNode(mediaStream: MediaStream): MediaStreamAudioSourceNodeInit`
  - `createAudioStatsGraphNode(options: StatsProcessorOptions & AnalyserOptions): AnalyzerNodeInit`
  - `createAudioStatsWorkletGraphNode(StatsProcessorOptions & AnalyserOptions): AudioStatsWorkletNodeInit`
  - `createDenoiseWorkletGraphNode(data: BufferSource): DenoiseWorkletNodeInit`
  - `createGainGraphNode(mute: boolean): GainNodeInit`
  - `createAnalyzerGraphNode(options?: AnalyserOptions): AnalyzerNodeInit`
  - `createStreamDestinationGraphNode(options?: AudioNodeOptions): MediaStreamAudioDestinationNodeInit`

- API to create `AudioGraph`
  - `createAudioGraph(inits: AudioNodeInit[], options?: AudioGraphOptions): AudioGraph`

### Removed

- Breaking Change: `createAudioAnalyzer` and related are removed.

## [0.8.4] - 2021-02-16

### Fixed

- Subscribe to the AudioContext's `onstatechange` to undo Safari's stream
  interruptions [#3205](https://github.com/pexip/aquila-research/issues/3205)

## [0.8.3] - 2021-02-02

### Fixed

- Add safe guard to avoid unnecessary calling AudioContext['close'] when it is
  in-process to fix
  [#3172](https://github.com/pexip/aquila-research/issues/3172)

## [0.8.2] - 2020-11-18

### Fixed

- Gain node error on safari [#2215]

## [0.8.1] - 2020-11-02

### Fixed

- Create `GainNode` to control volume with disabled track [#2119]

### Changed

- Remove `onAudioStats` message debug log to be less noisy [#2119]

## [0.8.0] - 2020-10-30

### Added

- Add debug logging using @pexip/logger [#2089]

### Fixed

- Fix infinite timeout call when using fallback mode for `onAudioStats` function
  [#2089]

## [0.7.3] - 2020-10-30

### Changed

- Remove hard link between `AudioContext['createMediaStreamSource']` and the
  pass-in `MediaStream` to avoid any side-effect done to the original stream by
  cloning [#2086]

## [0.7.2] - 2020-10-29

### Added

- Support Safari and possibly old browsers with webkit prefix
  [#2071](https://github.com/pexip/aquila-research/pull/2071)

## [0.7.1] - 2020-10-28

### Changed

- Stop source stream when releasing audio context
  [#2047](https://github.com/pexip/aquila-research/pull/2047)

## [0.7.0] - 2020-10-28

### Changed

- Remove the side effect of changing the audio track from the pass-in media
  stream. [#2036](https://github.com/pexip/aquila-research/pull/2036)

### Removed

- Remove `setAudioStreamMute`

## [0.6.2] - 2020-10-27

### Changed

- Sync audio track `enabled` state when constructing `GainNode`
  [#2003](https://github.com/pexip/aquila-research/pull/2003)

### Removed

- Remove `shouldInitMuted` option

## [0.6.1] - 2020-10-27

### Changed

- Stop the tracks from the destination stream when `release` is called
  [#2002](https://github.com/pexip/aquila-research/pull/2002)

## [0.6.0] - 2020-10-27

### Changed

- Skip `AudioWorkletProcessor` for browsers which do not support
  `AudioWorklet`[#1997](https://github.com/pexip/aquila-research/pull/1997)

- **BREAKING**: Remove suspend/resume as they are no longer needed
  [#1997](https://github.com/pexip/aquila-research/pull/1997)
- **BREAKING**: Rename `beforeAlter` to `beforeGain` for `getAverageVolume`
  options [#1997](https://github.com/pexip/aquila-research/pull/1997)

### Fixed

- Audio graph disconnection issue
  [#1997](https://github.com/pexip/aquila-research/pull/1997)

## [0.5.0] - 2020-10-21

### Added

- Expose suspend/resume/state from `AudioContext`
  [#1899](https://github.com/pexip/aquila-research/pull/1899)
- Sync mute state with suspend/resume
  [#1907](https://github.com/pexip/aquila-research/pull/1907)

### Changed

- Expose `running` instead of `state`
  [#1907](https://github.com/pexip/aquila-research/pull/1907)

### Fixed

- Fix multiple subscriptions issue for port message
  [#1907](https://github.com/pexip/aquila-research/pull/1907)

## [0.4.1] - 2020-10-16

### Changed

- Rename `worklet` files
  [#1846](https://github.com/pexip/aquila-research/pull/1846)
- Improve asynchronous processing
  [#1816](https://github.com/pexip/aquila-research/pull/1816)

### Fixed

- Eslint import type issues
  [#1786](https://github.com/pexip/aquila-research/pull/1786)
